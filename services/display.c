// vim: set tabstop=4 shiftwidth=4 expandtab :
//
// nixieclock-firmware - Nixie Clock Main Firmware Program
// Copyright (C) 2013 - 2015 Joe Ciccone
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//

#include <clock.h>
#include <display.h>
#include <ssd1306.h>
#include <stdio.h>
#include <timer.h>
#include <types.h>

// Display State
display_state_t display_state = 0;

// Display Dimm Timer ID
volatile int8_t display_dimm_timer = -1;

// Font Table for SSD1306 in Horizontal Address Mode
uint8_t dfont8x8[0x80][8] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x00 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x01 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x02 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x03 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x04 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x05 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x06 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x07 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x08 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x09 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x0A = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x0B = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x0C = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x0D = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x0E = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x0F = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x10 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x11 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x12 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x13 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x14 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x15 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x16 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x17 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x18 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x19 = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x1A = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x1B = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x1C = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x1D = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x1E = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x1F = [   ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x20 = [   ]
    { 0x00, 0x00, 0x06, 0x5F, 0x5F, 0x06, 0x00, 0x00 }, // 0x21 = [ ! ]
    { 0x00, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x00 }, // 0x22 = [ " ]
    { 0x14, 0x7F, 0x7F, 0x14, 0x7F, 0x7F, 0x14, 0x00 }, // 0x23 = [ # ]
    { 0x24, 0x2E, 0x6B, 0x6B, 0x3A, 0x12, 0x00, 0x00 }, // 0x24 = [ $ ]
    { 0x46, 0x66, 0x30, 0x18, 0x0C, 0x66, 0x62, 0x00 }, // 0x25 = [ % ]
    { 0x30, 0x7A, 0x4F, 0x5D, 0x37, 0x7A, 0x48, 0x00 }, // 0x26 = [ & ]
    { 0x04, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x27 = [ ' ]
    { 0x00, 0x1C, 0x3E, 0x63, 0x41, 0x00, 0x00, 0x00 }, // 0x28 = [ ( ]
    { 0x00, 0x41, 0x63, 0x3E, 0x1C, 0x00, 0x00, 0x00 }, // 0x29 = [ ) ]
    { 0x08, 0x2A, 0x3E, 0x1C, 0x1C, 0x3E, 0x2A, 0x08 }, // 0x2A = [ * ]
    { 0x08, 0x08, 0x3E, 0x3E, 0x08, 0x08, 0x00, 0x00 }, // 0x2B = [ + ]
    { 0x00, 0x80, 0xE0, 0x60, 0x00, 0x00, 0x00, 0x00 }, // 0x2C = [ , ]
    { 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00 }, // 0x2D = [ - ]
    { 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00 }, // 0x2E = [ . ]
    { 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00 }, // 0x2F = [ / ]
    { 0x3E, 0x7F, 0x71, 0x59, 0x4D, 0x7F, 0x3E, 0x00 }, // 0x30 = [ 0 ]
    { 0x40, 0x42, 0x7F, 0x7F, 0x40, 0x40, 0x00, 0x00 }, // 0x31 = [ 1 ]
    { 0x62, 0x73, 0x59, 0x49, 0x6F, 0x66, 0x00, 0x00 }, // 0x32 = [ 2 ]
    { 0x22, 0x63, 0x49, 0x49, 0x7F, 0x36, 0x00, 0x00 }, // 0x33 = [ 3 ]
    { 0x18, 0x1C, 0x16, 0x53, 0x7F, 0x7F, 0x50, 0x00 }, // 0x34 = [ 4 ]
    { 0x27, 0x67, 0x45, 0x45, 0x7D, 0x39, 0x00, 0x00 }, // 0x35 = [ 5 ]
    { 0x3C, 0x7E, 0x4B, 0x49, 0x79, 0x30, 0x00, 0x00 }, // 0x36 = [ 6 ]
    { 0x03, 0x03, 0x71, 0x79, 0x0F, 0x07, 0x00, 0x00 }, // 0x37 = [ 7 ]
    { 0x36, 0x7F, 0x49, 0x49, 0x7F, 0x36, 0x00, 0x00 }, // 0x38 = [ 8 ]
    { 0x06, 0x4F, 0x49, 0x69, 0x3F, 0x1E, 0x00, 0x00 }, // 0x39 = [ 9 ]
    { 0x00, 0x00, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00 }, // 0x3A = [ : ]
    { 0x00, 0x80, 0xE6, 0x66, 0x00, 0x00, 0x00, 0x00 }, // 0x3B = [ ; ]
    { 0x08, 0x1C, 0x36, 0x63, 0x41, 0x00, 0x00, 0x00 }, // 0x3C = [ < ]
    { 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x00, 0x00 }, // 0x3D = [ = ]
    { 0x00, 0x41, 0x63, 0x36, 0x1C, 0x08, 0x00, 0x00 }, // 0x3E = [ > ]
    { 0x02, 0x03, 0x51, 0x59, 0x0F, 0x06, 0x00, 0x00 }, // 0x3F = [ ? ]
    { 0x3E, 0x7F, 0x41, 0x5D, 0x5D, 0x1F, 0x1E, 0x00 }, // 0x40 = [ @ ]
    { 0x7C, 0x7E, 0x13, 0x13, 0x7E, 0x7C, 0x00, 0x00 }, // 0x41 = [ A ]
    { 0x41, 0x7F, 0x7F, 0x49, 0x49, 0x7F, 0x36, 0x00 }, // 0x42 = [ B ]
    { 0x1C, 0x3E, 0x63, 0x41, 0x41, 0x63, 0x22, 0x00 }, // 0x43 = [ C ]
    { 0x41, 0x7F, 0x7F, 0x41, 0x63, 0x3E, 0x1C, 0x00 }, // 0x44 = [ D ]
    { 0x41, 0x7F, 0x7F, 0x49, 0x5D, 0x41, 0x63, 0x00 }, // 0x45 = [ E ]
    { 0x41, 0x7F, 0x7F, 0x49, 0x1D, 0x01, 0x03, 0x00 }, // 0x46 = [ F ]
    { 0x1C, 0x3E, 0x63, 0x41, 0x51, 0x73, 0x72, 0x00 }, // 0x47 = [ G ]
    { 0x7F, 0x7F, 0x08, 0x08, 0x7F, 0x7F, 0x00, 0x00 }, // 0x48 = [ H ]
    { 0x00, 0x41, 0x7F, 0x7F, 0x41, 0x00, 0x00, 0x00 }, // 0x49 = [ I ]
    { 0x30, 0x70, 0x40, 0x41, 0x7F, 0x3F, 0x01, 0x00 }, // 0x4A = [ J ]
    { 0x41, 0x7F, 0x7F, 0x08, 0x1C, 0x77, 0x63, 0x00 }, // 0x4B = [ K ]
    { 0x41, 0x7F, 0x7F, 0x41, 0x40, 0x60, 0x70, 0x00 }, // 0x4C = [ L ]
    { 0x7F, 0x7F, 0x0E, 0x1C, 0x0E, 0x7F, 0x7F, 0x00 }, // 0x4D = [ M ]
    { 0x7F, 0x7F, 0x06, 0x0C, 0x18, 0x7F, 0x7F, 0x00 }, // 0x4E = [ N ]
    { 0x1C, 0x3E, 0x63, 0x41, 0x63, 0x3E, 0x1C, 0x00 }, // 0x4F = [ O ]
    { 0x41, 0x7F, 0x7F, 0x49, 0x09, 0x0F, 0x06, 0x00 }, // 0x50 = [ P ]
    { 0x1E, 0x3F, 0x21, 0x71, 0x7F, 0x5E, 0x00, 0x00 }, // 0x51 = [ Q ]
    { 0x41, 0x7F, 0x7F, 0x09, 0x19, 0x7F, 0x66, 0x00 }, // 0x52 = [ R ]
    { 0x26, 0x6F, 0x4D, 0x59, 0x73, 0x32, 0x00, 0x00 }, // 0x53 = [ S ]
    { 0x03, 0x41, 0x7F, 0x7F, 0x41, 0x03, 0x00, 0x00 }, // 0x54 = [ T ]
    { 0x7F, 0x7F, 0x40, 0x40, 0x7F, 0x7F, 0x00, 0x00 }, // 0x55 = [ U ]
    { 0x1F, 0x3F, 0x60, 0x60, 0x3F, 0x1F, 0x00, 0x00 }, // 0x56 = [ V ]
    { 0x7F, 0x7F, 0x30, 0x18, 0x30, 0x7F, 0x7F, 0x00 }, // 0x57 = [ W ]
    { 0x43, 0x67, 0x3C, 0x18, 0x3C, 0x67, 0x43, 0x00 }, // 0x58 = [ X ]
    { 0x07, 0x4F, 0x78, 0x78, 0x4F, 0x07, 0x00, 0x00 }, // 0x59 = [ Y ]
    { 0x47, 0x63, 0x71, 0x59, 0x4D, 0x67, 0x73, 0x00 }, // 0x5A = [ Z ]
    { 0x00, 0x7F, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00 }, // 0x5B = [ [ ]
    { 0x01, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00 }, // 0x5C = [ \ ]
    { 0x00, 0x41, 0x41, 0x7F, 0x7F, 0x00, 0x00, 0x00 }, // 0x5D = [ ] ]
    { 0x08, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x08, 0x00 }, // 0x5E = [ ^ ]
    { 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80 }, // 0x5F = [ _ ]
    { 0x00, 0x00, 0x03, 0x07, 0x04, 0x00, 0x00, 0x00 }, // 0x60 = [ ` ]
    { 0x20, 0x74, 0x54, 0x54, 0x3C, 0x78, 0x40, 0x00 }, // 0x61 = [ a ]
    { 0x41, 0x7F, 0x3F, 0x48, 0x48, 0x78, 0x30, 0x00 }, // 0x62 = [ b ]
    { 0x38, 0x7C, 0x44, 0x44, 0x6C, 0x28, 0x00, 0x00 }, // 0x63 = [ c ]
    { 0x30, 0x78, 0x48, 0x49, 0x3F, 0x7F, 0x40, 0x00 }, // 0x64 = [ d ]
    { 0x38, 0x7C, 0x54, 0x54, 0x5C, 0x18, 0x00, 0x00 }, // 0x65 = [ e ]
    { 0x48, 0x7E, 0x7F, 0x49, 0x03, 0x02, 0x00, 0x00 }, // 0x66 = [ f ]
    { 0x98, 0xBC, 0xA4, 0xA4, 0xF8, 0x7C, 0x04, 0x00 }, // 0x67 = [ g ]
    { 0x41, 0x7F, 0x7F, 0x08, 0x04, 0x7C, 0x78, 0x00 }, // 0x68 = [ h ]
    { 0x00, 0x44, 0x7D, 0x7D, 0x40, 0x00, 0x00, 0x00 }, // 0x69 = [ i ]
    { 0x60, 0xE0, 0x80, 0x80, 0xFD, 0x7D, 0x00, 0x00 }, // 0x6A = [ j ]
    { 0x41, 0x7F, 0x7F, 0x10, 0x38, 0x6C, 0x44, 0x00 }, // 0x6B = [ k ]
    { 0x00, 0x41, 0x7F, 0x7F, 0x40, 0x00, 0x00, 0x00 }, // 0x6C = [ l ]
    { 0x7C, 0x7C, 0x18, 0x38, 0x1C, 0x7C, 0x78, 0x00 }, // 0x6D = [ m ]
    { 0x7C, 0x7C, 0x04, 0x04, 0x7C, 0x78, 0x00, 0x00 }, // 0x6E = [ n ]
    { 0x38, 0x7C, 0x44, 0x44, 0x7C, 0x38, 0x00, 0x00 }, // 0x6F = [ o ]
    { 0x84, 0xFC, 0xF8, 0xA4, 0x24, 0x3C, 0x18, 0x00 }, // 0x70 = [ p ]
    { 0x18, 0x3C, 0x24, 0xA4, 0xF8, 0xFC, 0x84, 0x00 }, // 0x71 = [ q ]
    { 0x44, 0x7C, 0x78, 0x4C, 0x04, 0x1C, 0x18, 0x00 }, // 0x72 = [ r ]
    { 0x48, 0x5C, 0x54, 0x54, 0x74, 0x24, 0x00, 0x00 }, // 0x73 = [ s ]
    { 0x00, 0x04, 0x3E, 0x7F, 0x44, 0x24, 0x00, 0x00 }, // 0x74 = [ t ]
    { 0x3C, 0x7C, 0x40, 0x40, 0x3C, 0x7C, 0x40, 0x00 }, // 0x75 = [ u ]
    { 0x1C, 0x3C, 0x60, 0x60, 0x3C, 0x1C, 0x00, 0x00 }, // 0x76 = [ v ]
    { 0x3C, 0x7C, 0x70, 0x38, 0x70, 0x7C, 0x3C, 0x00 }, // 0x77 = [ w ]
    { 0x44, 0x6C, 0x38, 0x10, 0x38, 0x6C, 0x44, 0x00 }, // 0x78 = [ x ]
    { 0x9C, 0xBC, 0xA0, 0xA0, 0xFC, 0x7C, 0x00, 0x00 }, // 0x79 = [ y ]
    { 0x4C, 0x64, 0x74, 0x5C, 0x4C, 0x64, 0x00, 0x00 }, // 0x7A = [ z ]
    { 0x08, 0x08, 0x3E, 0x77, 0x41, 0x41, 0x00, 0x00 }, // 0x7B = [ { ]
    { 0x00, 0x00, 0x00, 0x77, 0x77, 0x00, 0x00, 0x00 }, // 0x7C = [ | ]
    { 0x41, 0x41, 0x77, 0x3E, 0x08, 0x08, 0x00, 0x00 }, // 0x7D = [ } ]
    { 0x02, 0x03, 0x01, 0x03, 0x02, 0x03, 0x01, 0x00 }, // 0x7E = [ ~ ]
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // 0x7F = [   ]
};

ssize_t dputc(const char c) {
    if (!(display_state & display_state_init)) {
        return 0;
    }
    if (display_state & display_state_invert) {
        uint8_t inverted_char[8];
        int i;
        for (i = 0; i < 8; i++) {
            inverted_char[i] = ~(dfont8x8[c & 0x7F][i]);
        }
        if (ssd1306_write_data(inverted_char, 8) < 0) {
            return -1;
        }
    } else {
        if (ssd1306_write_data(dfont8x8[c & 0x7F], 8) < 0) {
            return -1;
        }
    }
    return 1;
}

ssize_t dputs(const char *s) {
    ssize_t r = 0;
    if (!(display_state & display_state_init)) {
        return 0;
    }
    while (*s) {
        if (display_state & display_state_invert) {
            uint8_t inverted_char[8];
            int i;
            for (i = 0; i < 8; i++) {
                inverted_char[i] = ~(dfont8x8[*s & 0x7F][i]);
            }
            s++;
            if (ssd1306_write_data(inverted_char, 8) < 0) {
                r = -1;
                break;
            }
        } else {
            if (ssd1306_write_data(dfont8x8[*s++ & 0x7F], 8) < 0) {
                r = -1;
                break;
            }
        }
        r++;
    }
    return r;
}

ssize_t dprintf(const char *format, ...) {
    // Start the argument list
    __builtin_va_list args;
    __builtin_va_start(args, format);

    // Call the real printf
    ssize_t r = vxprintf(dputc, dputs, format, args);

    // Finish the argument list
    __builtin_va_end(args);

    // Return the Number of Printed Characers
    return r;
}

ssize_t dprintfr(const uint8_t row, const char *format, ...) {
    // Start the argument list
    __builtin_va_list args;
    __builtin_va_start(args, format);

    // Select the page and start at column 0
    ssd1306_set_page_start_addr(row);
    ssd1306_set_column_start_addr(0x00);

    // Call the real printf
    ssize_t r = vxprintf(dputc, dputs, format, args);

    // Finish the argument list
    __builtin_va_end(args);

    // Ensure an entire row is filled
    if ((r >= 0)) {
        while (r++ < 16) {
            dputc(' ');
        }
    }

    // Return the Number of Printed Characers
    return r;
}

void display_event_menu(int open) {
    if (open) {
        // Update the state
        display_state = (display_state & (~display_state_dimm)) | display_state_menu;

        // If the display is already bright, don't dimm it
        if (display_dimm_timer >= 0) {
            timer_del(display_dimm_timer);
            display_dimm_timer = -1;
        }

        // Brighten the display
        ssd1306_set_contrast(0xFF);
    } else {
        // Update the state
        if (!(display_state & display_state_menu)) {
            return;
        }

        // Clear the video memory
        display_erase_pages(0, 4);

        // Update the display state
        display_state = (display_state & (~display_state_menu));
    }
}

void display_event_dimm(uint32_t *again) {
    // Make sure the timer wasn't disabled in the meantime
    if (display_dimm_timer < 0) {
        return;
    }

    // Timer called back, update state and forget id
    display_state |= display_state_dimm;
    display_dimm_timer = -1;

    // Dimm the display
    ssd1306_set_contrast(0x00);
}

void display_event_clock(void) {
    // Skip if the display isn't idle
    if ((display_state & display_state_menu)) {
            return;
    }

    // Check if the display has been dimmed
    if (!(display_state & display_state_dimm)) {
        // Display is not dimm, are we waiting on a timer?
        if (display_dimm_timer < 0) {
            // No timer is set, set one
            display_dimm_timer = timer_set(display_event_dimm, 5);
        }
    }

    // Draw the Date
    ssd1306_set_page_start_addr(0x00);
    ssd1306_set_column_start_addr(0x00);
    dprintf("%s, %s %02u %04u",
        clock_day_name[clock.day],
        clock_month_name[clock.month],
        clock.date,
        clock.year);

    // Draw the Time
    ssd1306_set_page_start_addr(0x02);
    ssd1306_set_column_start_addr(0x1C);
    dprintf("%02u:%02u:%02u",
        clock.hour,
        clock.minute,
        clock.second);

}

int display_erase_pages(uint8_t page_start, uint8_t page_count) {
    uint8_t page, col;
    for (page = page_start; page < page_start + page_count; page++) {
        if (ssd1306_set_page_start_addr(page) < 0) {
            return -1;
        }

        if (ssd1306_set_column_start_addr(0x00) < 0) {
            return -1;
        }

        for (col = 0; col < 0x80; col += 0x08) {
            if (ssd1306_write_data(dfont8x8[' '], 8) < 0) {
                return -1;
            }
        }
    }
    return 0;
}

void display_init(void) {
    // Initialize the Display Controller
    if (ssd1306_set_display_on(0x0) < 0) {
        kputs("Failed to Write to SSD1306 OLED Controller\r\n");
    } else {
        ssd1306_set_multiplex_ratio(0x1F);
        ssd1306_set_display_offset(0x00);
        ssd1306_set_display_start_line(0x00);
        ssd1306_set_segment_remap(0x1);
        ssd1306_set_com_scan_dir(0x1);
        ssd1306_set_com_pins(0x0, 0x0);
        ssd1306_set_contrast(0xFF);
        ssd1306_set_precharge_period(0xF, 0x1);
        ssd1306_set_vcomh(0x4);
        ssd1306_set_entire_display_on(0x0);
        ssd1306_set_display_invert(0x0);

        // Clear the RAM
        display_erase_pages(0, 8);

        // Enable the Charge Pump and Turn On the Display
        ssd1306_set_clock_ratio(0x8, 0x0);
        ssd1306_set_charge_pump_enable(0x1);
        ssd1306_set_display_on(0x1);

        // Mark the service as initialized
        display_state |= display_state_init;
    }
}
